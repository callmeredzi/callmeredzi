name: Generate Aquarium

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate Aquarium SVG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: callmeredzi
        run: |
          python << 'PYEOF'
          import requests
          import os

          username = os.environ.get('USERNAME', 'callmeredzi')
          token = os.environ.get('GITHUB_TOKEN', '')

          headers = {'Authorization': f'token {token}'} if token else {}

          # Fetch GitHub stats
          user_data = requests.get(f'https://api.github.com/users/{username}', headers=headers).json()
          repos_data = requests.get(f'https://api.github.com/users/{username}/repos?per_page=100', headers=headers).json()

          public_repos = user_data.get('public_repos', 5)
          followers = user_data.get('followers', 0)
          total_stars = sum(repo.get('stargazers_count', 0) for repo in repos_data) if isinstance(repos_data, list) else 0

          # Fish count based on repos (min 3, max 10)
          fish_count = min(max(public_repos, 3), 10)
          
          # Bubble count based on followers
          bubble_count = min(max(followers // 5 + 3, 3), 8)

          # Colors for fish
          fish_colors = ['#ff3333', '#3399ff', '#ffcc00', '#33cc66', '#9966ff', '#ff6699', '#00cccc', '#ff9933', '#66ff66', '#cc66ff']
          
          # Generate fish SVG elements
          fish_svgs = []
          positions = [(80, 80), (150, 120), (200, 150), (350, 60), (450, 100), (550, 140), (250, 50), (400, 160), (600, 90), (500, 70)]
          speeds = [15, 12, 18, 10, 14, 16, 11, 13, 17, 9]
          directions = [1, -1, 1, -1, 1, -1, 1, -1, 1, -1]  # 1 = right, -1 = left
          
          for i in range(fish_count):
              x, y = positions[i % len(positions)]
              color = fish_colors[i % len(fish_colors)]
              speed = speeds[i % len(speeds)]
              direction = directions[i % len(directions)]
              
              if direction == 1:
                  fish_svgs.append(f'''
            <g>
              <animateTransform attributeName="transform" type="translate" values="0,0;700,0;0,0" dur="{speed}s" repeatCount="indefinite"/>
              <ellipse cx="{x}" cy="{y}" rx="{20 - i}" ry="{12 - i//2}" fill="{color}"/>
              <polygon points="{x-25},{y} {x-40},{y-12} {x-40},{y+12}" fill="{color}"/>
              <circle cx="{x+10}" cy="{y-3}" r="3" fill="#fff"/>
              <circle cx="{x+11}" cy="{y-3}" r="1.5" fill="#000"/>
            </g>''')
              else:
                  fish_svgs.append(f'''
            <g>
              <animateTransform attributeName="transform" type="translate" values="600,0;-100,0;600,0" dur="{speed}s" repeatCount="indefinite"/>
              <ellipse cx="{x}" cy="{y}" rx="{20 - i}" ry="{12 - i//2}" fill="{color}"/>
              <polygon points="{x+25},{y} {x+40},{y-12} {x+40},{y+12}" fill="{color}"/>
              <circle cx="{x-10}" cy="{y-3}" r="3" fill="#fff"/>
              <circle cx="{x-11}" cy="{y-3}" r="1.5" fill="#000"/>
            </g>''')

          # Generate bubbles
          bubble_svgs = []
          bubble_positions = [100, 200, 300, 400, 500, 600, 700, 150]
          bubble_speeds = [4, 5, 3.5, 4.5, 3, 5.5, 4, 3.8]
          
          for i in range(bubble_count):
              bx = bubble_positions[i % len(bubble_positions)]
              bs = bubble_speeds[i % len(bubble_speeds)]
              br = 3 + (i % 3)
              bubble_svgs.append(f'''
            <circle cx="{bx}" cy="160" r="{br}" fill="#fff" opacity="0.3">
              <animate attributeName="cy" values="180;20;180" dur="{bs}s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.3;0.1;0.3" dur="{bs}s" repeatCount="indefinite"/>
            </circle>''')

          svg = f'''<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 200">
            <defs>
              <linearGradient id="water" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#1a3a5c"/>
                <stop offset="100%" style="stop-color:#0d1f33"/>
              </linearGradient>
            </defs>
            
            <!-- Tank -->
            <rect x="10" y="10" width="780" height="180" rx="10" fill="url(#water)" stroke="#2a5a8a" stroke-width="3"/>
            
            <!-- Bubbles ({bubble_count} based on {followers} followers) -->
            {''.join(bubble_svgs)}
            
            <!-- Seaweed -->
            <path d="M80,190 Q85,150 75,120 Q85,100 80,70" stroke="#2d5a27" stroke-width="4" fill="none">
              <animate attributeName="d" values="M80,190 Q85,150 75,120 Q85,100 80,70;M80,190 Q75,150 85,120 Q75,100 80,70;M80,190 Q85,150 75,120 Q85,100 80,70" dur="3s" repeatCount="indefinite"/>
            </path>
            <path d="M720,190 Q725,160 715,130 Q725,110 720,80" stroke="#3d6a37" stroke-width="4" fill="none">
              <animate attributeName="d" values="M720,190 Q725,160 715,130 Q725,110 720,80;M720,190 Q715,160 725,130 Q715,110 720,80;M720,190 Q725,160 715,130 Q725,110 720,80" dur="2.5s" repeatCount="indefinite"/>
            </path>
            
            <!-- Fish ({fish_count} fish = {public_repos} repos) -->
            {''.join(fish_svgs)}
            
            <!-- Ground -->
            <ellipse cx="400" cy="192" rx="380" ry="12" fill="#c4a574"/>
            <ellipse cx="150" cy="185" rx="30" ry="10" fill="#666"/>
            <ellipse cx="650" cy="183" rx="25" ry="8" fill="#555"/>
            
            <!-- Stats -->
            <text x="400" y="8" text-anchor="middle" fill="#8b949e" font-family="monospace" font-size="8">üêü {fish_count} fish ({public_repos} repos) | ‚≠ê {total_stars} stars | üë• {followers} followers</text>
          </svg>'''

          with open('aquarium.svg', 'w') as f:
              f.write(svg)
          print(f"Generated aquarium with {fish_count} fish!")
          PYEOF

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: .
          keep_history: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
